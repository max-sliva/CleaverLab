<!DOCTYPE html>
<html>
<head>
    <script src="konva.min.js"></script>
    <meta charset="utf-8"/>
    <title>Konva Drag and Drop an Image Demo</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #f0f0f0;
        }
    </style>
</head>
<body>
   <div id="container"></div>  <!-- контейнер для объектов Konva-->
   <script>
        var conStart = null;
        var width = window.innerWidth;
        var height = window.innerHeight-100;
        var stage = new Konva.Stage({
            container: 'container',
            width: width,
            height: height,
        });
        var layer = new Konva.Layer();

        var objTargets = [];
        var line = new Konva.Line({
            points: [0, 0, 0, 0],
            stroke: 'green',
            strokeWidth: 2,
        });
        // layer.add(line);
        stage.add(layer);
        var group = new Konva.Group({ //группа для объектов Konva, чтоб двигать все объекты
            x: 20,
            y: 0,
            draggable: true,
        });
        let i = 0;
        let objMap = new Map();
        function drawImage(imageObj) { //создание Konva.Image с нужным изображением
            // darth vader
            var img = new Konva.Image({
                image: imageObj,
                x: i*220+20,
                y: 0,
                width: 200,
                height: 137,
                // draggable: true,
            });
            if (i>0) {
                img.setDraggable(true);
                console.log("2nd image");
                img.on('click', function(){ //для добавления красной рамки ардуино
                    const box1=stage.find('.redBox');
                    // console.log("box = ", box);
                    box1.destroy();
                    let box = new Konva.Rect({
                        name: "redBox",
                        x: img.x(),
                        y: img.y(),
                        width: img.width()+1,
                        height: img.height()+1,
                        // fill: 'white',
                        stroke: 'red',
                        strokeWidth: 2,
                    });
                    console.log("click! x=",img.x(), "i=",i);
                    layer.add(box);
                });
            } else {
                img.on('click', function (){ //для удаления красной рамки ардуино
                    console.log("raspi click!");
                    const box=stage.find('.redBox');
                    // console.log("box = ", box);
                    box.destroy();
                });
            }

            i++;
            // add cursor styling
            img.on('mouseover', function () {
                document.body.style.cursor = 'pointer';
            });
            img.on('mouseout', function () {
                document.body.style.cursor = 'default';
            });
            layer.add(img);
            stage.add(layer);
            objTargets.push(img);
            return img;
        }

        var raspiImg = new Image();
        var usbPorts = [];
        let portNum = -1;
        raspiImg.onload = function () {
            const img = drawImage(this);
            group.add(img);
            // objTargets.push(group);
            for (var i = 0; i < 4; i++) {
                let box = new Konva.Rect({ //рамка вокруг надписи
                    x: img.width() - 25,
                    y: img.y() + 5 + (i) * 20,
                    width: 40,
                    height: 15,
                    name: 'USB' + i,
                    fill: 'white',
                    stroke: 'black',
                    strokeWidth: 2,
                });
                group.add(box);
                var usb = new Konva.Text({ //надписи USB
                    text: 'USB'+i,
                    x: img.width() - 24,
                    y: img.y() + 6 + (i)*20,
                    fontSize: 14,
                    width: 200,
                });
                usbPorts.push(usb);
                usb.on('click', function () {
                    conStart = this;
                    console.log('selected ',conStart.text());
                    portNum = usbPorts.indexOf(conStart);
                    console.log("i = ", portNum);
                    // line.points([group.x()+objTargets[0].width()+20, group.y()+(portNum*box.height())+(portNum+1)*(box.height()/2), objTargets[1].x(), objTargets[1].y()+objTargets[1].height()/2]);
                    let box2=layer.find('.redBox');
                    // console.log("box=", box2[0].name());
                    if  (box2[0]!==undefined && !objMap.has(box2[0]))  {
                        // line.points([group.x()+objTargets[0].width()+20, 5+group.y()+(portNum*usbPorts[0].height())+(portNum+1)*(usbPorts[0].height()/2), objTargets[1].x(), objTargets[1].y()+objTargets[1].height()/2]);
                        // line.points([group.x()+objTargets[0].width()+20, 5+group.y()+(portNum*usbPorts[0].height())+(portNum+1)*(usbPorts[0].height()/2), box2[0].x(), box2[0].y()+box2[0].height()/2]);
                        //TODO сделать добавление линии в массив и изменение текущей линии
                        // layer.add(line);
                        let newLine = new Konva.Line({
                            points: [group.x()+objTargets[0].width()+20, 5+group.y()+(portNum*usbPorts[0].height())+(portNum+1)*(usbPorts[0].height()/2), box2[0].x(), box2[0].y()+box2[0].height()/2],
                            stroke: 'green',
                            strokeWidth: 2,
                        });
                        objMap.set(box2[0], newLine);
                        layer.add(newLine);
                        layer.batchDraw();
                    }
                });

                group.add(usb);
            }
            // group.add(usb);
            layer.add(group);
            stage.add(layer);
        };
        raspiImg.src = 'RaspberryPi_3B.png';
        var arduImg = new Image();
        arduImg.onload = function () {
            drawImage(this);
            layer.add(line);
            stage.add(layer);
            objTargets.forEach((target) => {
                target.on('dragmove', updateLine);
            });
            group.on('dragmove', updateLine);
        };
        arduImg.src = 'iskra2.jpg';

        function updateLine() { //обновление положения концов линии
            // console.log("raspiImage x = ", group.x(), " arduImage x = ", arduImg.x);
            // line.points([objTargets[0].x()+objTargets[0].width(), objTargets[0].y()+objTargets[0].height()/2, objTargets[1].x(), objTargets[1].y()+objTargets[1].height()/2]);
            // line.points([group.x()+objTargets[0].width()+20, group.y()+usbPorts[0].height()/2, objTargets[1].x(), objTargets[1].y()+objTargets[1].height()/2]);
            // if (portNum != -1) line.points([group.x()+objTargets[0].width()+20, 5+group.y()+(portNum*usbPorts[0].height())+(portNum+1)*(usbPorts[0].height()/2), objTargets[1].x(), objTargets[1].y()+objTargets[1].height()/2]);
            for (let obj of objMap.keys()) {
                console.log('obj = ', obj);
            }
            console.log('objMap.size = ', objMap.size);
            layer.batchDraw();
        }
        var container = stage.container();
        container.tabIndex = 1;// make it focusable
        // focus it
        // also stage will be in focus on its click
        container.focus();
        const DELTA = 4;
        container.addEventListener('keydown', function (e) {
            if (e.keyCode === 27) {
                console.log('ESC pressed')
            }  else {
                return;
            }
            e.preventDefault();
            layer.batchDraw();
        });
        function addArdu(){
            drawImage(arduImg);
        }
    </script>
   <button id="btn1" onclick="addArdu()">Add Arduino</button>
   <button onclick="check()"><input type="checkbox" id="check" /> Toggle image visibility</button>

<!--TODO сделать сохранение в JSON https://konvajs.org/docs/data_and_serialization/Serialize_a_Stage.html и передать в БД-->
</body>
</html>